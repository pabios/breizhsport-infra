# BreizhSport Infrastructure Repository

This repository orchestrates the `auth` and `product` microservices for BreizhSport using Docker Compose. It also includes a shared PostgreSQL database used by both microservices.

## Prerequisites

Ensure the following are installed on your machine:

- [Docker](https://docs.docker.com/get-docker/)
- [Docker Compose](https://docs.docker.com/compose/install/)
- Git

## Repository Structure

```
BreizhSport-infra/
├── docker-compose.yml
├── README.md
```

## Services

### 1. `auth`
This service handles user authentication and is built from the `auth` microservice repository.

- **Context**: `../auth`
- **Ports**: `8081`
- **Environment Variables**: Loaded from `../auth/.env`

### 2. `product`
This service manages product-related operations and is built from the `product` microservice repository.

- **Context**: `../product`
- **Ports**: `8082`
- **Environment Variables**: Loaded from `../product/.env`

### 3. `database`
This service provides a shared PostgreSQL database for both microservices.

- **Image**: `postgres:15.9-bullseye`
- **Ports**: `5432`
- **Volumes**: Data is stored persistently in the `db_data` volume.

## Getting Started

### Clone Repositories

Ensure the `auth` and `product` repositories are cloned alongside the `infra` repository in the same parent directory:

```
parent_directory/
├── breizhsport-auth/
├── breizhsport-product/
├── breizhsport-infra/
```

### Build and Start Services

Run the following command in the `breizhsport-infra` directory to build and start the services:

```bash
docker-compose up --build
```

This will:
- Build and start the `auth` service on port `8081`.
- Build and start the `product` service on port `8082`.
- Start the PostgreSQL database on port `5432`.

### Access Services

- **Auth API**: `http://localhost:8081`
- **Product API**: `http://localhost:8082`

## Environment Variables

### `auth` Microservice
Located in `../auth/.env`:
```
APP_ENV=dev
APP_SECRET=<your_secret>
DATABASE_URL="postgresql://postgres:postgres@database:5432/breizhsport_auth_db"
JWT_SECRET_KEY="/path/to/private.pem"
JWT_PUBLIC_KEY="/path/to/public.pem"
JWT_PASSPHRASE=<your_passphrase>
```

### `product` Microservice
Located in `../product/.env`:
```
APP_ENV=dev
APP_SECRET=<your_secret>
DATABASE_URL="postgresql://postgres:postgres@database:5432/breizhsport_product_db"
JWT_PUBLIC_KEY="/path/to/public.pem"
```

## Stopping Services

To stop the running services, execute:

```bash
docker-compose down
```

This will stop and remove all running containers, but data in the PostgreSQL database will persist in the `db_data` volume.

## Reset Database

To reset the database and remove all data, delete the `db_data` volume:

```bash
docker-compose down -v
```

Then, recreate the services:

```bash
docker-compose up --build
```

## Troubleshooting

### Database Connection Issues

Ensure the `DATABASE_URL` environment variables in the `auth` and `product` microservices point to the `database` service:
```
postgresql://postgres:postgres@database:5432/<db_name>
```

### JWT Issues

Ensure the `JWT_PUBLIC_KEY` in the `product` microservice matches the `JWT_PUBLIC_KEY` generated by the `auth` microservice.

## Contribution

To contribute to this project, fork the repository, make your changes, and submit a pull request.

## License

This project is licensed under the MIT License.

